# 서버 구조 개론

지금까지 우리가 만들 서버의 구조

1. GameLogic : 1개 쓰레드
2. Network Recieve : N개 쓰레드
3. Network Send : 1개 쓰레드
4. DB : 1개 쓰레드

실제 MMO를 살펴보면 

로그인을 하면 바로 인 게임으로 가는 것이 아니라 서버를 고르게 되어있다.

왜 이렇게 서버를 나눠놨을까? 그리고 어떻게 구현할 수 있을까?

단일 서버가 매우 어려운 이유

아래 3가지 부하 이슈 때문이다.

- 네트워크 부하 (I/O)
- DB 부하(I/O)
- 게임 로직 부하(CPU ⇒ 몬스터 AI 등)

물리적으로 컴퓨터를 늘려서 분산한다면?

⇒ 웹 서버에서 사용하는 Scale Out가 같이

MMO에서는 이렇게 처리하기가 애매하다.

왜나하면 다른 지역에 있는 유저들끼리 동기화를 하기가 어렵기 때문

즉, 서로 다른 서버에 있는 플레이들의 순서를 맞추는 문제가 매우 어렵다.

그리고 가장 큰 난제는 DB 부하를 해결할 수가 없다.

웹에서는 DB를 분산해서 좋아지던데요?

MMO에서는 콘텐츠끼리 서로 연관성이 있기 때문이다.

예를들어 쿠팡에서 치킨을 주문을 하면 이것은 나랑만 관련이 있지 다른 유저들과 연관은 없다.

서로 완전 독립적인 경우 DB를 분산을 시켜주면 DB도 아름답게 동작하면서 큰 효과를 가질 수 있다.

하지만 MMO의 경우는 모든 콘텐츠가 여러 플레이어들과 얽혀있기 때문이다.

예를들어 2명의 플레이어가 서로 아이템을 교환한다고 했을 때 (각각 다른 DB에서 데이터 관리 중)

그렇게 되면 2개의 DB를 동시에 수정을 해야하므로 lock을 걸어서 해결하는 수밖에 없다.

하지만 lock을 걸게 되면 이렇게 만든 의미가 없다.

따라서 실제 MMO에서는 서버군을 만들게 된다.

즉 서버가 다르면 관리하는 DB가 달라지게 된다. ⇒ 따라서 완전 다른 게임 세상이다.

추가로 현재 DB를 설계할 때 Acount 정보도 같이 넣어놨는데

위와 같이 DB를 늘려서 서버군으로 만든다 할지라도 AccountDB는 서로 공유를 해야한다.

따라서 한 계정한 한번만 참여 가능한 이벤트가 위와 같은 원리 위에서 돌아간다.

따라서 AcountServer가 필요하다.

여기서 문제는 Account Server를 웹서버로 만들지 TCP 서버로 만들지가 고민이다.

Account 서버가 필요한 이유는 로그인을 하고 서버를 고르는 창을 띄어주기 위함이기 때문에

굳이 TCP 서버로 만들어야할까 싶지만 

대기열 시스템을 구현하려면 실시간으로 연결이 되어있어야 하기 때문에 조금 애매하다.

그럼에도 웹서버로 만든다고 하면 웹서버에서 주도적으로 클라이언트에게 데이터를 전달해줄 수 없기 때문에 클라에서 3초에 한번씩 웹서버에게 요청을 보내서 Pooling 방식으로 요청을 하는 식으로 구현을 해볼 수 있다.