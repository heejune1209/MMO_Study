# 대형구조 관리 이론

MMO와 같은 대형 구조에서는 지금과 같은 방법 만으로는 애매한 상황이 많이 발생을 한다. 

MMO라고 해도 심리스 여부에 따라 난이도가 10배 이상으로 뛰게 된다.

즉, 기존에 만들었던 Room System과 심리스 MMO는 어떠한 차이가 있을지가 오늘 강의의 핵심이다.

와우와 같은 게임에서 각 대륙을 거대한 방이라고 생각하고 만들면 되지 않을까 추측을 했었다.

하지만 유저가 어마무시하게 늘었을 때 이런 식으로 방 하나를 대륙 단위로 관리하는 게 맞다 싶다.

사실 방을 만든 이유는 멀티쓰레드를 처리하기 위해서 즉, 방 마다 담당하는 쓰레드를 두고 처리를 하기 위함이였는데, 

너무 큰 방에서 수많은 유저들을 하나의 쓰레드만 처리하는 것이 맞는가 의문이다.

그래서 좀 더 고민을 해서 대륙을 지역 단위로 나눠서 관리를 하면 어떨까 싶은데 

실제로도 이런 방법이 일반적으로 괜찮긴 하다.

즉 각 유저가 여러 지역 단위로 흩어져 있으면 이상적인 상황인 것이다.

하지만 MMO에서는 이렇게 흩어져 있지 않고 콘텐츠에 따라 한 지역에 몰려 있는 경우가 더러 있다.

따라서 MMO에서 가장 큰 난제는 한 곳에 유저가 몰렸을 때 처리하는 것이다.

동시 접속자 수가 중요한 것이 아니라 동일한 공간에 얼마나 많은 유저가 밀집하고 있는지가 관건

이걸 해결할 수 있는 방법이 뚜렷하게 있는 것은 아니다.

심리스 MMO에서 공간 단위로 분할을 시켜서 관리를 할 경우 굉장한 애매한 상황이 생긴다.

예를 들어,

A지역에 유저 1명 그리고 바로 옆 지역인 B 지역에 유저 한명이 각각 존재한다고 가정을 해보자.

특정 영역으로 넘어갈 때 포탈로 넘어가는 것이 아니라 그냥 넘어가는 상황에서는 굉장히 애매해지는 상황이 발생한다.

왜나하면 지금까지 배운 GameRoom에서 Broadcasting을 하는 상태에서는 같은 지역 안(GameRoom 안)에 있는 유저들한테 Broadcasting을 해준다.

하지만 다른 지역에 있는 유저한테 스킬을 쓴다고 가정을 하면 여기서부터 골치가 아프게 된다.

즉 가장 큰 난제는 이렇게 지역을 쪼개게 되면 다른 지역에 있는 유저와 어떻게 동기화를 할 것이냐 이다.

내가 담당하는 공간이 다르다 ⇒ Job을 처리하는 쓰레드가 다르다

이렇게 담당하는 쓰레드가 다를 경우 많은 문제들이 있는데 그 중 대표적으로

1. Broadcast 관련 문제
2. 순서 보장 관련 문제
3. 멀티쓰레드 관련 문제

이렇게 3가지가 있다.

### 1. Broadcast 관련 문제

Broadcasting 절대 범위가 GameRoom이 아니게 된다. 

해결 방법?

- 경계선에 있는 객체들은 특별 처리를 해야할지

- 인접한 Room에도 별도로 Broadcasting을 한다든지

### 2. 순서 보장 관련 문제

각기 다른 공간에서 처리하는 쓰레드들의 작업 순서가 보장이 안되는 이슈가 발생한다.

예를 들어 서빙 직원 2명이 각각 주문을 받는 상황이라고 볼 수 있다.

주문을 A 직원, B 직원 순서대로 받았음에도 실제로는 B 직원의 주문이 먼저 처리 될 수 있다.

이렇게 선입 선출 개념이 깨지면 가끔씩 골치 아픈 상황이 발생하게 된다.

게임 로직을 짤 때 예약한 작업을 순서대로 한다는 가정 하에서 짰지만 

다른 쓰레드들이 처리하는 일감을 받아서 구현을 해야 할 경우 순서 보장이 제대로 이루어지지 않게 된다.

그리고 한명의 유저가 체력이 지속적으로 -10씩 감소를 하는 상황에서 두 지역을 왔다갔다 하게 됐을 때 A 지역에서는 체력을 90으로 만들어야 한다는 연산과 B 지역에서는 체력을 80으로 만들어야하는 연산을 해야 한다면,

이를 처리하는 순서가 보장이 되지 않기 때문에 B 지역 → A지역 순으로 처리가 된다면 

체력이 결국 90이 되는 이상한 상황이 발생하게 된다.

이런 상황을 예방하기 위해서 여러가지 안전처리가 필요하게 된다.

아무튼 쓰레드가 각 영역을 담당하는 식으로 구현을 하게 되면 이런 식으로 경계선에서 발생하는 이슈들이 생기게 된다.

### 3. 멀티쓰레드 관련 문제

A 지역에 있는 유저와 B 지역에 있는 유저가 서로 전투를 해야하는 상황에서 

B 유저가 A 유저에게 스킬을 날렸을 때 해당 스킬이 상대방 체력이 30프로 이하이면 추가 스킬이 발생하는 패시브가 있다고 가정을 해보자.

해당 연산을 하기 위해서 B 유저는 A 유저의 정보가 필요하게 되는데 그냥 단순하게  player.Hp로 상대방 Hp 정보를 가지고 오려고 하지만 서로 담당하는 쓰레드가 다르기 때문에 마냥 단순하게 상대방의 정보를 가지고 올 수 없게 된다.

왜냐하면 해당 정보를 가지고 왔을 시점에 lock을 걸지 않고 그냥 가지고 왔을 때 해당 정보가 100프로 유효한지 알 수가 없는 게 해당 유저 정보를 긁어 오는 순간에 해당 유저의 Hp 정보가 변경될 수도 있기 때문이다.

즉, 유효성에 대한 확신이 없는 것이 첫 번째 문제이다.

두 번째 상황은 A 유저가 특정 아이템을 들고 있다면 스킬 데미지가 감소하게 된다.

A 유저가 들고 있는 Item의 정보를 Dictionary와 같은 자료구조에서 관리를 하고 있기 때문에 lock을 걸지 않고 멋대로 하나씩 스캔을 하다 보면 크래쉬가 날 수가 있다.

List나 Dictionary 같은 자료구조는 lock을 걸지 않고 안전하게 데이터를 뽑아와야 하는데 그게 아니라 B 유저가 A 유저의 Item 정보를 순회하는 중에 A 유저가 아이템 정보를 변경하게 되면 null 크래쉬 등 다양한 문제가 발생할 수 있게 된다.

이렇게 다른 영역에 있는 유저들과 통신을 하는 것이 매우 어려운 문제이다.

참고 삼아서 실제 심리스 MMO 게임에서 하는 방식은 결국에는 두가지 처리 방식이 있다.

하나는 기존 방식과 같이 Zone 단위로 관리를 하는 것이고 두 번째는 공간을 두는 것이 아니라 JobSerializer를 Object에 두는 것이다.

플레이어 뿐만 아니라 몬스터, 화살 등 모든 객체에 JobSerializer를 둬서 

모든 일감 들을 오브젝트 단위로 Serializing을 해서 같은 오브젝트의 행동만 서로 순서 보장을 하는 식으로 만드는 경우도 있다.

이렇게 오브젝트 단위로 Serializing을 하게 되면 또 굉장히 어려워지는 게 A 플레이어가 B 플레이어의 체력을 깎고 싶다면 지금까지 한 공간에서 처리를 했으면 A 플레이어의 코드가 실행이 됐다가 B 플레이어로 넘어가서 B 플레이어의 체력을 깍고 나오는 식으로 처리가 가능했지만

이제는 하나 하나 GameRoom으로 보면 된다. 그러기 때문에 다른 객체를 건드려야할 때는 Job을 만들어서 다른 Player의 JobQueue에 넣고 나오는 식으로 바뀌어야 한다.