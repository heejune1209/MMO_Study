# DB 연동 마무리

나머지 콘텐츠들도 지금까지 해왔던 것과 비슷하게 추가 작업을 해주면 된다.

추가 부연설명

DB를 연동할 때 지금은 ORM을 사용했지만 실무에서는 ORM보다는 DBA가 따로 있어서 SQL 스크립트를 따로 만들어 준다.

우리는 만들어준 SQL 스크립트를 호출하는 코드를 짜주게 된다.

우리가 직접 자동화해서 만든 ORM을 사용하든 다른 사람이 만든 SQL을 사용하든

방식은 크게 다르지 않다.

즉, 게임을 관리하는 쓰레드(현재는 GameRoom 쓰레드)에서 곧바로 DB 실행하지 않고 다른 쓰레드에게 떠넘겨서 DB에 저장 후 완료 신호를 받아서 처리하는 작업을 진행해준다.

단일 서버 같은 경우는 DB를 처리하는 쓰레드를 별도로 두는 경우가 있고 DB와 관련된 작업은 캐쉬 서버와 같은 개념으로 DB만 전용으로 분산해서 서버를 두는 경우가 있다.

DB 설계와 같은 경우도 난이도가 있는 작업이다.

즉 ItemDb에 있는 Slot과 OwnerId를 통해서 내가 어떤 플레어에게 소속이 되어 있는지 또는 인벤토리인지 착용 중인지 등을 관리해주고 있는데 

지금은 한명의 플레이어의 경우만 생각을 하고 있었기 때문에 크게 어렵지 않게 생각할 수 있다.

하지만 EquipItemNoti를 사용하면서 아이템을 벗는 부분과 착용하는 부분을 따로 관리를 하고 있었다.

하지만 항상 이렇게 분리하면서 작업을 하게 되면은 항상 최악의 경우를 생각해야 한다.

DB 로직이 실패해서 아이템을 벗는 부분까지는 실행이 되었지만 아이템을 착용하는 부분에서 Crashing이 날 수가 있다.

거래창 콘텐츠를 만들 때 

거래창 위에 아이템을 올리고 승락을 하면 서로의 아이템을 바꿔야 할 때

나의 아이템의 ownerId는 상대방 것으로

상대방 아이템의 ownerId는 내것으로 바꿔줘야 한다.

이런 상황에서 위의 최악의 경우가 발생하면 아주 큰일 나는 상황이다.

따라서 DB를 작업 할 때는 해당 작업이 중요한 작업인가를 살펴야 하고

정말 중요한 작업이라면 Transanction으로 묶어서 원자적으로

다 성공하거나 다 실패하거나 하는 상황이 발생해야 한다면 

따로 분리 시키지 말고 반드시 한번에 실행될 수 있도록 묶어줘야 한다.

이것을 SQL로 만들 때는 Transanction으로 묶어서 처리하는 방법에 대해서 DB 시간에 배운 방식대로 무조건 만들어줘야 한다.

지금처럼 EF Core로 만들어줘야 하는 경우에는 SaveChanges를 호출 하기 전에는 모두 transanction으로 묶여서 처리가 되니깐 그나마 빠르게 작업이 가능하다.

아무튼 핵심적인 내용은

ORM을 사용하니깐 DB가 쉽게 느껴지겠지만 실질적으로 회사에 들어가서 작업을 할 때는 절때 무시를 못하는 작업이다.

해당 부분에서 실수가 일어나면 아이템이 복사가 일어나건 치명적으로 3천만원 집행검이 상대방에게 넘어갈 수가 있다.

또 하나,

현재 작업에서는 DBManager를 하나만 두고 있어서 유일한 DB 관리자이다.

식당으로 치면 결제를 담당하는 직원이 한명 밖에 없다.

이렇게 결제 직원을 한명만 두게 되면 DB 처리 작업을 하나씩 순차적으로 진행을 해주게 되어서

별다른 문제가 없게 되는데

나중에 DB 부하가 심해져서 DbTransaction을 여러개 둔다고 가정해보자.

이렇게 되면 애매한 경우가 많이 발생하게 된다.

앞선 최악의 사례처럼 아이템을 벗고 입는 작업에서 

아이템을 벗는 부분과 아이템을 입는 부분을 각기 다른 쓰레드한테 일감을 떠넘기게 되면은

반드시 순서가 보장된다고 이야기 할 수가 없다.

그렇게 된다고 하면 생각보다 로직이 꼬일 확률이 비약적으로 높아지기 때문에 또 골치 아픈 일이 발생하게 된다.

따라서 인디게임 수준에서는 DB를 관리하는 쓰레드는 하나로 하는 것을 추천한다.

회사에서는 동접 5천명 이상을 관리를 해야 하니깐 DB 쓰레드를 하나만 두기는 애매해진다.

그래서 DB를 관리하는 쓰레드를 여러개 두게 되면 순서 보장 문제가 발생을 하게 되고 

일감끼리 순서 보장을 하기 위한 lock을 두고 온갖 처리를 하게 된다.

⇒ 너무 고급 내용이라 여기서 이야기 하기는 힘듦

아무튼 DB 쓰레드를 여러개 두게 되면 순서 보장에 대한 이슈가 발생을 하게 된다는 점만 이해하면 좋을 듯